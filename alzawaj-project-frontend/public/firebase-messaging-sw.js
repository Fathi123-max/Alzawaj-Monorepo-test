// Import the Firebase app and messaging libraries for service worker
importScripts(
  "https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js",
);
importScripts(
  "https://www.gstatic.com/firebasejs/9.0.0/firebase-messaging-compat.js",
);

// Initialize Firebase
// This section is auto-generated by scripts/generate-sw.js
if (firebase.apps.length === 0) {
  firebase.initializeApp({
  "apiKey": "AIzaSyDzdqugkDPMPbl8wGq9NZYjAxqJ8SVXqEc",
  "authDomain": "alzawaj-test.firebaseapp.com",
  "projectId": "alzawaj-test",
  "storageBucket": "alzawaj-test.firebasestorage.app",
  "messagingSenderId": "218305689666",
  "appId": "1:218305689666:web:ad8c9baa57d165f0b315db"
});
}


// Handle background push notifications
self.addEventListener("push", function (event) {
  console.log("Received background push message ", event);

  try {
    const payload = event.data.json();

    const notificationTitle = payload.notification
      ? payload.notification.title
      : "Notification";
    const notificationOptions = {
      body:
        payload.notification && payload.notification.body
          ? payload.notification.body
          : "",
      icon: "/logo.png", // Use your app's logo
      data: payload.data || {},
    };

    event.waitUntil(
      self.registration.showNotification(
        notificationTitle,
        notificationOptions,
      ),
    );
  } catch (err) {
    console.error("Error handling push event:", err);

    // Fallback notification if parsing fails
    event.waitUntil(
      self.registration.showNotification("Notification", {
        body: "You have a new notification",
        icon: "/logo.png",
      }),
    );
  }
});

// Handle notification click
self.addEventListener("notificationclick", function (event) {
  console.log("Notification click received.", event.notification);
  console.log("Notification data:", event.notification.data);

  event.notification.close();

  // Determine the URL to open based on notification type
  let urlPath = "/dashboard";
  
  const notificationData = event.notification.data || {};
  const notificationType = notificationData.type;
  
  // Handle different notification types
  if (notificationType === "message" && notificationData.chatRoomId) {
    // Navigate to the specific chat room
    urlPath = `/dashboard/chat?chatRoomId=${notificationData.chatRoomId}`;
    console.log("Opening chat room:", notificationData.chatRoomId);
  } else if (notificationData.url) {
    // Use custom URL if provided
    urlPath = notificationData.url;
  }

  // Try to focus an existing window/tab if the app is already open
  event.waitUntil(
    clients.matchAll({ 
      type: "window", 
      includeUncontrolled: true 
    })
      .then(function (clientList) {
        console.log("Found", clientList.length, "open windows");
        
        // Check if there's already a window open with our app
        for (let i = 0; i < clientList.length; i++) {
          const client = clientList[i];
          const clientUrl = new URL(client.url);
          console.log("Checking client:", client.url);
          
          // Check if this is our app (same origin) and user is likely authenticated
          // (not on login page)
          if (clientUrl.origin === self.location.origin && 
              !clientUrl.pathname.includes('/login') &&
              !clientUrl.pathname.includes('/register')) {
            console.log("Found authenticated window, focusing and navigating to:", urlPath);
            
            return client.focus().then(() => {
              // Send message to client to navigate
              client.postMessage({
                type: "NOTIFICATION_CLICK",
                url: urlPath,
                data: notificationData
              });
              return client;
            });
          }
        }
        
        // If no authenticated window found, open new one
        // Use full URL to ensure proper navigation
        const fullUrl = self.location.origin + urlPath;
        console.log("No authenticated window found, opening new window:", fullUrl);
        return clients.openWindow(fullUrl);
      })
      .catch(function (error) {
        console.error("Error handling notification click:", error);
        // Fallback: open the URL
        const fullUrl = self.location.origin + urlPath;
        return clients.openWindow(fullUrl);
      })
  );
});


