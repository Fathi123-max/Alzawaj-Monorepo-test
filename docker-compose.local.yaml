services:
  # Frontend service for local development
  frontend:
    build:
      context: ./alzawaj-project-frontend
      dockerfile: Dockerfile
      target: development
    container_name: alzawaj-frontend-local
    ports:
      - "${FRONTEND_PORT:-3000}:3000"
    env_file:
      - ./.env.local
    environment:
      - NODE_ENV=${NODE_ENV:-development}
      - NEXT_PUBLIC_APP_NAME=${NEXT_PUBLIC_APP_NAME:-Alzawaj Platform}
      - NEXT_PUBLIC_APP_DESCRIPTION=${NEXT_PUBLIC_APP_DESCRIPTION:-Islamic Marriage Platform}
      - NEXT_PUBLIC_APP_URL=${NEXT_PUBLIC_APP_URL:-http://localhost:3000}
      - NEXT_PUBLIC_API_BASE_URL=${NEXT_PUBLIC_API_BASE_URL:-http://localhost:5001}
      - NEXT_PUBLIC_ENABLE_CHAT=${NEXT_PUBLIC_ENABLE_CHAT:-true}
      - NEXT_PUBLIC_ENABLE_NOTIFICATIONS=${NEXT_PUBLIC_ENABLE_NOTIFICATIONS:-true}
      - NEXT_PUBLIC_ENABLE_PHOTOS=${NEXT_PUBLIC_ENABLE_PHOTOS:-true}
      - NEXT_PUBLIC_FIREBASE_API_KEY=${NEXT_PUBLIC_FIREBASE_API_KEY}
      - NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN=${NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN}
      - NEXT_PUBLIC_FIREBASE_PROJECT_ID=${NEXT_PUBLIC_FIREBASE_PROJECT_ID}
      - NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET=${NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET}
      - NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID=${NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID}
      - NEXT_PUBLIC_FIREBASE_APP_ID=${NEXT_PUBLIC_FIREBASE_APP_ID}
      - NEXT_PUBLIC_FIREBASE_VAPID_KEY=${NEXT_PUBLIC_FIREBASE_VAPID_KEY}
      - NEXT_PUBLIC_IMAGEKIT_PUBLIC_KEY=${NEXT_PUBLIC_IMAGEKIT_PUBLIC_KEY}
      - NEXT_PUBLIC_IMAGEKIT_URL_ENDPOINT=${NEXT_PUBLIC_IMAGEKIT_URL_ENDPOINT}
      - BACKEND_API_URL=${BACKEND_API_URL:-http://backend:5001}
      - NEXT_PUBLIC_BACKEND_API_URL=${NEXT_PUBLIC_BACKEND_API_URL:-http://backend:5001}
      - PORT=3000
      - HOSTNAME=0.0.0.0
    volumes:
      - ./alzawaj-project-frontend:/app
    networks:
      - alzawaj-local-network
    restart: unless-stopped
    working_dir: /app
    command: pnpm run dev
    healthcheck:
      test: [ "CMD", "node", "-e", "require('http').get('${NEXT_PUBLIC_APP_URL:-http://localhost:3000}', (res) => { process.exit(res.statusCode === 200 ? 0 : 1) }).on('error', () => process.exit(1))" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # Backend service for local development
  backend:
    build:
      context: ./alzawaj-project-backend
      dockerfile: Dockerfile
      target: development
    container_name: alzawaj-backend-local
    ports:
      - "${BACKEND_PORT:-5001}:5001"
    env_file:
      - ./.env.local
    environment:
      - NODE_ENV=${NODE_ENV:-development}
      - PORT=${BACKEND_PORT:-5001}
      - MONGODB_URI=${MONGODB_URI:-mongodb://mongodb:27017/alzawaj-dev}
      - JWT_SECRET=${JWT_SECRET}
      - JWT_EXPIRES_IN=${JWT_EXPIRES_IN:-7d}
      - JWT_REFRESH_SECRET=${JWT_REFRESH_SECRET}
      - JWT_REFRESH_EXPIRES_IN=${JWT_REFRESH_EXPIRES_IN:-30d}
      - CORS_ORIGIN=${CORS_ORIGIN:-http://localhost:3000,http://127.0.0.1:3000,http://frontend:3000}
      - CORS_CREDENTIALS=${CORS_CREDENTIALS:-true}
      - REDIS_URL=${REDIS_URL:-redis://redis:6379}
      - FRONTEND_URL=${FRONTEND_URL:-http://localhost:3000}
      - BCRYPT_ROUNDS=${BCRYPT_ROUNDS:-10}
      - LOG_LEVEL=${LOG_LEVEL:-debug}
      - LOG_FILE_PATH=${LOG_FILE_PATH:-./logs/app-dev.log}
      - MAX_FILE_SIZE=${MAX_FILE_SIZE:-10485760}
      - ALLOWED_FILE_TYPES=${ALLOWED_FILE_TYPES:-jpg,jpeg,png,pdf}
      - RATE_LIMIT_MAX_REQUESTS=${RATE_LIMIT_MAX_REQUESTS:-1000}
      - RATE_LIMIT_WINDOW_MS=${RATE_LIMIT_WINDOW_MS:-900000}
      - ENABLE_METRICS=${ENABLE_METRICS:-true}
      - HEALTH_CHECK_INTERVAL=${HEALTH_CHECK_INTERVAL:-30000}
      - DEBUG=${DEBUG:-alzawaj:*}
      - ENABLE_DEBUG_LOGS=${ENABLE_DEBUG_LOGS:-true}
      - API_TIMEOUT=${API_TIMEOUT:-30000}
      - ENABLE_REQUEST_LOGGING=${ENABLE_REQUEST_LOGGING:-true}
      - USE_MOCK_SERVICES=${USE_MOCK_SERVICES:-false}
      - NODE_OPTIONS=--inspect=0.0.0.0:9229
      # ImageKit Configuration
      - IMAGEKIT_PUBLIC_KEY=${IMAGEKIT_PUBLIC_KEY}
      - IMAGEKIT_PRIVATE_KEY=${IMAGEKIT_PRIVATE_KEY}
      - IMAGEKIT_URL_ENDPOINT=${IMAGEKIT_URL_ENDPOINT}
      - IMAGEKIT_ROOT_FOLDER=${IMAGEKIT_ROOT_FOLDER:-alzawaj-images-dev/}
      # Firebase Configuration
      - FIREBASE_PROJECT_ID=${FIREBASE_PROJECT_ID}
      - FIREBASE_CLIENT_EMAIL=${FIREBASE_CLIENT_EMAIL}
      - FIREBASE_PRIVATE_KEY_ID=${FIREBASE_PRIVATE_KEY_ID}
      - FIREBASE_PRIVATE_KEY=${FIREBASE_PRIVATE_KEY}
      # SMTP Configuration
      - SMTP_HOST=${SMTP_HOST}
      - SMTP_PORT=${SMTP_PORT}
      - SMTP_USER=${SMTP_USER}
      - SMTP_PASS=${SMTP_PASS}
      - SMTP_SECURE=${SMTP_SECURE}
      # Resend Email Service Configuration
      - RESEND_API_KEY=${RESEND_API_KEY}
      - RESEND_SENDER_EMAIL=${RESEND_SENDER_EMAIL}
      - RESEND_SENDER_NAME=${RESEND_SENDER_NAME}
    volumes:
      - ./alzawaj-project-backend:/app
      - /app/node_modules
      - ./logs:/app/logs
    networks:
      - alzawaj-local-network
    restart: unless-stopped
    command: pnpm run dev
    healthcheck:
      test: [ "CMD", "node", "-e", "require('http').get('http://localhost:${BACKEND_PORT:-5001}/health', (res) => { process.exit(res.statusCode === 200 ? 0 : 1) }).on('error', () => process.exit(1))" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # MongoDB service for local development
  mongodb:
    image: mongo:7
    container_name: alzawaj-mongodb-local
    ports:
      - "${MONGODB_PORT:-27017}:27017"
    volumes:
      - mongodb_data_local:/data/db
      - ./mongodb-init:/docker-entrypoint-initdb.d:ro
    environment:
      - MONGO_INITDB_DATABASE=alzawaj-dev
    networks:
      - alzawaj-local-network
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "mongosh", "--eval", "db.adminCommand('ping')" ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # Redis service for local development (for rate limiting)
  redis:
    image: redis:7-alpine
    container_name: alzawaj-redis-local
    ports:
      - "${REDIS_PORT:-6380}:6379"
    volumes:
      - redis_data_local:/data
    command: [ "redis-server" ]
    networks:
      - alzawaj-local-network
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "redis-cli", "ping" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

# Networks
networks:
  alzawaj-local-network:
    driver: bridge

# Volumes
volumes:
  mongodb_data_local:
    driver: local
  redis_data_local:
    driver: local